name: COBOL Check Automation

on:
  push:
    branches: [ "main" ]
  pull_request:
    branches: [ "main" ]

jobs:
  cobol-check:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout Repository
        uses: actions/checkout@v3

      - name: Set up Node.js
        uses: actions/setup-node@v3
        with:
          node-version: '18'

      - name: Install system dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y libsecret-1-0

      - name: Install Zowe CLI
        run: |
          npm install -g @zowe/cli

      - name: Create Zowe Config (SSH only)
        env:
          ZOWE_USER: ${{ secrets.ZOWE_USERNAME }}
          ZOWE_PASSWORD: ${{ secrets.ZOWE_PASSWORD }}
          ZOWE_HOST: 204.90.115.200
          ZOWE_PORT: 22
        run: |
          mkdir -p ~/.zowe
          cat > ~/.zowe/zowe.config.json <<EOF
          {
            "profiles": {
              "ssh": {
                "type": "ssh",
                "properties": {
                  "host": "$ZOWE_HOST",
                  "port": $ZOWE_PORT,
                  "user": "$ZOWE_USER",
                  "password": "$ZOWE_PASSWORD"
                }
              }
            },
            "defaults": {
              "ssh": "ssh"
            }
          }
          EOF
          echo "Config file created at ~/.zowe/zowe.config.json"

      - name: Test Zowe Config
        run: |
          zowe profiles list all
          zowe zos-uss issue ssh "echo 'SSH connection OK!'"

      - name: Run COBOL Check
        run: |
          echo "Running COBOL Check..."
          # exemplo de execução - ajuste conforme seu caso
          zowe zos-uss issue ssh "cobol-check --version"
